{% extends "base.html" %}

{% block title %}Supply Chain Analytics{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 font-sans">
    <!-- Sidebar -->
    {% include 'components/sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 overflow-auto flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 px-8 py-4 flex justify-between items-center z-10">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Supply Chain Analytics</h1>
                <p class="text-sm text-gray-500">Real-time tracking of Production, Distribution & Returns</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="{{ url_for('download_report') }}" target="_blank"
                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm font-semibold text-sm">
                    <i class="fas fa-file-download"></i> Export PDF
                </a>
                <span class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-bold border border-blue-100">
                    {{ session.get('user', {}).get('name', 'Admin') }}
                </span>
            </div>
        </header>

        <main class="p-8 flex-1">
            <!-- AI INSIGHTS CARD -->
            <div
                class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 shadow-lg mb-8 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="fas fa-robot text-9xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                            <i class="fas fa-sparkles text-yellow-300"></i>
                        </div>
                        <h3 class="font-bold text-lg">AI Supply Chain Insights</h3>
                    </div>
                    <div id="ai-loading" class="animate-pulse flex space-x-4">
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-2 bg-white/30 rounded w-3/4"></div>
                            <div class="h-2 bg-white/30 rounded w-1/2"></div>
                        </div>
                    </div>
                    <p id="ai-content" class="text-white/90 text-sm leading-relaxed hidden whitespace-pre-line">
                        Analyzing your data...
                    </p>
                </div>
            </div>

            <!-- KPIS -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <!-- Manufactured -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-blue-50 rounded-xl text-blue-600">
                            <i class="fas fa-industry text-xl"></i>
                        </div>
                    </div>
                    <h3 class="text-gray-500 text-sm font-medium">Total Manufactured</h3>
                    <p class="text-3xl font-bold text-gray-800 mt-1">{{ stats.manufactured }}</p>
                    <p class="text-xs text-gray-400 mt-2">Units in stock</p>
                </div>

                <!-- In Transit/Distributed -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-purple-50 rounded-xl text-purple-600">
                            <i class="fas fa-truck text-xl"></i>
                        </div>
                    </div>
                    <h3 class="text-gray-500 text-sm font-medium">Distributed Stock</h3>
                    <p class="text-3xl font-bold text-gray-800 mt-1">{{ stats.distributed }}</p>
                    <p class="text-xs text-gray-400 mt-2">Cases moved</p>
                </div>

                <!-- Returned Waste -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-green-50 rounded-xl text-green-600">
                            <i class="fas fa-recycle text-xl"></i>
                        </div>
                    </div>
                    <h3 class="text-gray-500 text-sm font-medium">Returned Waste</h3>
                    <p class="text-3xl font-bold text-gray-800 mt-1">{{ stats.returned }}</p>
                    <p class="text-xs text-gray-400 mt-2">Items recovered</p>
                </div>

                <!-- Efficiency Rate -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-indigo-50 rounded-xl text-indigo-600">
                            <i class="fas fa-chart-line text-xl"></i>
                        </div>
                    </div>
                    <h3 class="text-gray-500 text-sm font-medium">Recovery Rate</h3>
                    <p class="text-3xl font-bold text-gray-800 mt-1">N/A</p>
                </div>
            </div>

            <!-- CHARTS ROW 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Flow Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6">Supply Chain Flow</h3>
                    <canvas id="flowChart" height="250"></canvas>
                </div>

                <!-- Category Breakdown -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-6">Production by Category</h3>
                    <canvas id="categoryChart" height="250"></canvas>
                </div>
            </div>

            <!-- TOP MOVERS TABLE -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">Top Distributors (Volume)</h3>
                    <button class="text-sm text-blue-600 font-medium hover:underline">View Full Report</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-xs text-gray-500 uppercase tracking-wider">
                                <th class="px-8 py-4 font-semibold">Distributor Name</th>
                                <th class="px-8 py-4 font-semibold text-right">Volume</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 text-sm">
                            <tr class="hover:bg-gray-50/50 transition-colors">
                                <td class="px-8 py-4 font-medium text-gray-900">Calculated in detailed report</td>
                                <td class="px-8 py-4 text-right font-bold text-blue-600">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // FLOW CHART (Sankey-like Logic)
    const flowCtx = document.getElementById('flowChart').getContext('2d');
    new Chart(flowCtx, {
        type: 'bar',
        data: {
            labels: ['Manufactured', 'Transferred (Dist)', 'Returned (Waste)'],
            datasets: [{
                label: 'Volume (Units)',
                data: [{{ stats.manufactured }}, {{ stats.distributed }}, {{ stats.returned }}],
        backgroundColor: ['#2563EB', '#9333EA', '#16A34A'],
        borderRadius: 8
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true, grid: { display: false } },
            x: { grid: { display: false } }
        }
    }
    });

    // CATEGORY CHART
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(catCtx, {
        type: 'doughnut',
        data: {
            labels: ['Beverages', 'Water', 'Food', 'Household', 'Inductrial'],
            datasets: [{
                data: [45, 25, 15, 10, 5],
                backgroundColor: ['#3B82F6', '#60A5FA', '#93C5FD', '#BFDBFE', '#EFF6FF'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    });

    // FETCH AI INSIGHTS
    document.addEventListener('DOMContentLoaded', function () {
        const aiContent = document.getElementById('ai-content');
        const aiLoading = document.getElementById('ai-loading');

        fetch('/reports/insights')
            .then(response => response.json())
            .then(data => {
                aiLoading.classList.add('hidden');
                aiContent.classList.remove('hidden');

                if (data.status === 'success' && data.data && data.data.insight) {
                    aiContent.innerText = data.data.insight;
                } else {
                    aiContent.innerText = "Could not generate insights at this time as the service is offline.";
                }
            })
            .catch(err => {
                console.error("AI Error:", err);
                aiLoading.classList.add('hidden');
                aiContent.classList.remove('hidden');
                aiContent.innerText = "AI Service unavailable.";
            });
    });
</script>
{% endblock %}