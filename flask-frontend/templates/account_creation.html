{% extends "base.html" %}

{% block title %}Create Account - Africa Waste Solutions{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/webcam-easy/1.0.5/webcam-easy.min.js"></script>
{% endblock %}

{% block content %}
<div class="min-h-screen flex w-full">
    <!-- LEFT SIDE: Branding & Certifications -->
    <div
        class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-blue-900 via-blue-950 to-slate-900 text-white flex-col justify-between px-16 py-12 relative overflow-hidden">
        <!-- Background decorative elements -->
        <div
            class="absolute top-0 left-0 w-96 h-96 bg-blue-800 opacity-20 rounded-full mix-blend-multiply filter blur-3xl">
        </div>
        <div
            class="absolute bottom-0 right-0 w-96 h-96 bg-blue-700 opacity-20 rounded-full mix-blend-multiply filter blur-3xl">
        </div>

        <div class="z-10 animate-fade-in-up">
            <!-- Logo & Title -->
            <div class="flex flex-col items-center text-center mb-16">
                <div class="mb-6">
                    <i class="fas fa-recycle text-6xl text-white drop-shadow-lg"></i>
                </div>
                <h1 class="text-4xl font-bold mb-4">Africa Waste Solutions</h1>
                <p class="text-blue-100 text-lg max-w-md">
                    Intelligent waste management and environmental tracking for a sustainable Zambia
                </p>
            </div>

            <!-- Certification Badges -->
            <div class="grid grid-cols-3 gap-6 mt-12">
                <!-- ZEMA Certified -->
                <div
                    class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20 text-center hover:bg-white/15 transition-all animate-fade-in-up animate-delay-200">
                    <div class="flex justify-center mb-3">
                        <i class="fas fa-shield-alt text-3xl text-blue-300"></i>
                    </div>
                    <h3 class="font-bold text-sm mb-2">ZEMA Certified</h3>
                    <p class="text-xs text-green-100 leading-relaxed">
                        Zambia Environmental Management Agency approved platform for waste tracking and environmental
                        compliance monitoring
                    </p>
                </div>

                <!-- Ministry Approved -->
                <div
                    class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20 text-center hover:bg-white/15 transition-all animate-fade-in-up animate-delay-300">
                    <div class="flex justify-center mb-3">
                        <i class="fas fa-check-circle text-3xl text-blue-300"></i>
                    </div>
                    <h3 class="font-bold text-sm mb-2">Ministry Approved</h3>
                    <p class="text-xs text-green-100 leading-relaxed">
                        Official Ministry of Green Economy partnership for national waste management initiatives and
                        sustainability programs
                    </p>
                </div>

                <!-- Data Protected -->
                <div
                    class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20 text-center hover:bg-white/15 transition-all animate-fade-in-up animate-delay-400">
                    <div class="flex justify-center mb-3">
                        <i class="fas fa-lock text-3xl text-blue-300"></i>
                    </div>
                    <h3 class="font-bold text-sm mb-2">Data Protected</h3>
                    <p class="text-xs text-green-100 leading-relaxed">
                        Full compliance with Zambian Data Protection Act ensuring secure handling of all business and
                        personal information
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer - empty div for spacing -->
        <div></div>
    </div>

    <!-- RIGHT SIDE: Account Creation Form -->
    <div class="w-full lg:w-1/2 bg-gray-50 flex items-center justify-center p-8 overflow-y-auto">
        <div class="w-full max-w-2xl bg-white p-10 rounded-3xl shadow-2xl my-8 animate-fade-in-up animate-delay-200">
            <!-- Header -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Create Account</h2>
                <p class="text-gray-600">Join our waste management platform</p>
            </div>

            <!-- Progress Bar -->
            <div class="mb-8 flex items-center justify-between">
                <div class="flex items-center gap-2 text-blue-600 font-bold" id="step1-indicator">
                    <span
                        class="w-10 h-10 rounded-full border-2 border-current flex items-center justify-center text-sm">1</span>
                    <span class="hidden sm:inline text-sm">Details</span>
                </div>
                <div class="h-1 flex-1 mx-2 sm:mx-4 bg-gray-300 rounded">
                    <div id="progress-bar-1" class="h-full bg-blue-600 transition-all rounded w-1/3"></div>
                </div>
                <div class="flex items-center gap-2 text-gray-400" id="step2-indicator">
                    <span
                        class="w-10 h-10 rounded-full border-2 border-current flex items-center justify-center text-sm">2</span>
                    <span class="hidden sm:inline text-sm">Type</span>
                </div>
                <div class="h-1 flex-1 mx-2 sm:mx-4 bg-gray-300 rounded">
                    <div id="progress-bar-2" class="h-full bg-blue-600 transition-all rounded w-0"></div>
                </div>
                <div class="flex items-center gap-2 text-gray-400" id="step3-indicator">
                    <span
                        class="w-10 h-10 rounded-full border-2 border-current flex items-center justify-center text-sm">3</span>
                    <span class="hidden sm:inline text-sm">KYC</span>
                </div>
            </div>

            <form method="POST" action="{{ url_for('account_creation') }}" enctype="multipart/form-data"
                id="accountForm">
                <!-- STEP 1: Personal Details -->
                <div id="step1" class="space-y-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Personal Information</h3>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Full Name / Company Name <span class="text-red-500">*</span>
                        </label>
                        <input name="fullName" type="text" required
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all text-gray-900"
                            placeholder="e.g. John Doe" />
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Contact Number <span class="text-red-500">*</span>
                        </label>
                        <input name="contact" type="tel" required
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all text-gray-900"
                            placeholder="+260..." />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Plot Number <span class="text-red-500">*</span>
                            </label>
                            <input name="plotNumber" type="text" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all text-gray-900"
                                placeholder="Plot number" />
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Area / Layout</label>
                            <input name="area" type="text"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent transition-all text-gray-900"
                                placeholder="Area name" />
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Account Type -->
                <div id="step2" class="space-y-6 hidden">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Account Classification</h3>
                    <p class="text-gray-600 mb-6">Please select the category that best describes this account.</p>

                    <input type="hidden" name="accountType" id="accountTypeInput" value="consumer">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Consumer Option -->
                        <div onclick="selectAccountType('consumer')" id="consumer-card"
                            class="cursor-pointer p-8 rounded-xl border-2 border-blue-600 bg-blue-50 shadow-lg flex flex-col items-center justify-center gap-4 transition-all">
                            <i class="fas fa-user text-5xl text-blue-600"></i>
                            <span class="font-bold text-lg">Consumer</span>
                            <p class="text-sm text-center text-gray-600">Household, Small Office, or Institution
                                generating waste.</p>
                        </div>

                        <!-- Business Option -->
                        <div onclick="selectAccountType('business')" id="business-card"
                            class="cursor-pointer p-8 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:shadow-md flex flex-col items-center justify-center gap-4 transition-all">
                            <i class="fas fa-building text-5xl text-gray-400"></i>
                            <span class="font-bold text-lg">Business</span>
                            <p class="text-sm text-center text-gray-600">Manufacturer, Wholesaler, or Retailer supplying
                                goods.</p>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: KYC -->
                <div id="step3" class="space-y-8 hidden">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Identity Verification (KYC)</h3>

                    <!-- ID Upload Section -->
                    <div
                        class="border-2 border-dashed border-gray-300 rounded-xl p-8 flex flex-col items-center text-center bg-gray-50 hover:border-blue-400 transition-colors">
                        <i class="fas fa-file-upload text-gray-400 text-5xl mb-4"></i>
                        <h4 class="font-bold text-gray-700 mb-2">Upload ID Document</h4>
                        <p class="text-sm text-gray-500 mb-4">Passport, NRC, or Driver's License</p>

                        <div id="id-preview" class="hidden mb-4">
                            <img id="id-image" src="" alt="ID Preview"
                                class="h-40 object-contain rounded-lg border-2 border-gray-200 shadow-sm" />
                            <button type="button" onclick="clearIdImage()"
                                class="mt-2 bg-red-500 text-white rounded-lg px-4 py-2 hover:bg-red-600 transition-colors">
                                Remove
                            </button>
                        </div>

                        <input type="file" name="id_document" id="id-input" accept="image/*,.pdf"
                            onchange="previewIdImage(event)"
                            class="text-sm text-gray-600 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer file:transition-colors" />
                    </div>

                    <!-- Selfie Section -->
                    <div
                        class="border-2 border-dashed border-gray-300 rounded-xl p-8 flex flex-col items-center text-center bg-gray-50 hover:border-blue-400 transition-colors">
                        <i class="fas fa-camera text-gray-400 text-5xl mb-4"></i>
                        <h4 class="font-bold text-gray-700 mb-2">Liveness Check (Selfie)</h4>
                        <p class="text-sm text-gray-500 mb-4">Please position your face in the frame.</p>

                        <div id="selfie-preview" class="hidden mb-4">
                            <img id="selfie-image" src="" alt="Selfie"
                                class="h-56 rounded-lg border-2 border-gray-200 shadow-sm" />
                            <button type="button" onclick="clearSelfie()"
                                class="mt-2 bg-red-500 text-white rounded-lg px-4 py-2 hover:bg-red-600 transition-colors">
                                Remove
                            </button>
                        </div>

                        <div id="webcam-container" class="flex flex-col items-center gap-4">
                            <video id="webcam" autoplay playsinline
                                class="h-56 w-72 bg-black rounded-lg shadow-lg"></video>
                            <button type="button" onclick="captureSelfie()"
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md">
                                <i class="fas fa-camera mr-2"></i>
                                Capture Photo
                            </button>
                        </div>
                        <input type="hidden" name="selfie" id="selfie-data">
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="mt-8 flex justify-between items-center pt-6 border-t border-gray-200">
                    <button type="button" id="backBtn" onclick="previousStep()"
                        class="hidden text-gray-600 font-semibold px-6 py-3 hover:bg-gray-100 rounded-lg transition-colors">
                        ← Back
                    </button>

                    <button type="button" id="nextBtn" onclick="nextStep()"
                        class="bg-blue-700 text-white font-bold px-8 py-4 rounded-lg hover:bg-blue-800 ml-auto shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                        Next Step →
                    </button>

                    <button type="submit" id="submitBtn"
                        class="hidden ml-auto font-bold px-8 py-4 rounded-lg shadow-lg transition-all transform bg-blue-700 text-white hover:bg-blue-800 hover:shadow-xl hover:-translate-y-0.5">
                        Verify & Create Account
                    </button>
                </div>
            </form>

            <!-- Footer -->
            <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                <span class="text-gray-600 text-sm">Already have an account? </span>
                <a href="{{ url_for('login') }}"
                    class="text-blue-700 hover:text-blue-800 font-semibold text-sm transition-colors">
                    Sign In
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    let stream = null;

    // Initialize webcam when page loads
    window.addEventListener('load', function () {
        initWebcam();
    });

    function initWebcam() {
        const video = document.getElementById('webcam');
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then(function (mediaStream) {
                stream = mediaStream;
                video.srcObject = stream;
            })
            .catch(function (err) {
                console.log("Webcam error: " + err);
            });
    }

    function nextStep() {
        if (currentStep < 3) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.remove('hidden');

            // Update progress indicators
            updateProgress();

            // Show/hide buttons
            document.getElementById('backBtn').classList.remove('hidden');
            if (currentStep === 3) {
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('submitBtn').classList.remove('hidden');
            }
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            currentStep--;
            document.getElementById(`step${currentStep}`).classList.remove('hidden');

            // Update progress indicators
            updateProgress();

            // Show/hide buttons
            if (currentStep === 1) {
                document.getElementById('backBtn').classList.add('hidden');
            }
            document.getElementById('nextBtn').classList.remove('hidden');
            document.getElementById('submitBtn').classList.add('hidden');
        }
    }

    function updateProgress() {
        // Update step indicators
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById(`step${i}-indicator`);
            if (i <= currentStep) {
                indicator.classList.remove('text-gray-400');
                indicator.classList.add('text-blue-600', 'font-bold');
            } else {
                indicator.classList.remove('text-blue-600', 'font-bold');
                indicator.classList.add('text-gray-400');
            }
        }

        // Update progress bars
        const bar1 = document.getElementById('progress-bar-1');
        const bar2 = document.getElementById('progress-bar-2');

        if (currentStep === 1) {
            bar1.style.width = '33%';
            bar2.style.width = '0%';
        } else if (currentStep === 2) {
            bar1.style.width = '66%';
            bar2.style.width = '0%';
        } else if (currentStep === 3) {
            bar1.style.width = '100%';
            bar2.style.width = '100%';
        }
    }

    function selectAccountType(type) {
        document.getElementById('accountTypeInput').value = type;

        const consumerCard = document.getElementById('consumer-card');
        const businessCard = document.getElementById('business-card');

        if (type === 'consumer') {
            consumerCard.className = 'cursor-pointer p-8 rounded-xl border-2 border-blue-600 bg-blue-50 shadow-lg flex flex-col items-center justify-center gap-4 transition-all';
            consumerCard.querySelector('i').className = 'fas fa-user text-5xl text-blue-600';
            businessCard.className = 'cursor-pointer p-8 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:shadow-md flex flex-col items-center justify-center gap-4 transition-all';
            businessCard.querySelector('i').className = 'fas fa-building text-5xl text-gray-400';
        } else {
            businessCard.className = 'cursor-pointer p-8 rounded-xl border-2 border-blue-600 bg-blue-50 shadow-lg flex flex-col items-center justify-center gap-4 transition-all';
            businessCard.querySelector('i').className = 'fas fa-building text-5xl text-blue-600';
            consumerCard.className = 'cursor-pointer p-8 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:shadow-md flex flex-col items-center justify-center gap-4 transition-all';
            consumerCard.querySelector('i').className = 'fas fa-user text-5xl text-gray-400';
        }
    }

    function previewIdImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('id-image').src = e.target.result;
                document.getElementById('id-preview').classList.remove('hidden');
                document.getElementById('id-input').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    function clearIdImage() {
        document.getElementById('id-image').src = '';
        document.getElementById('id-preview').classList.add('hidden');
        document.getElementById('id-input').classList.remove('hidden');
        document.getElementById('id-input').value = '';
    }

    function captureSelfie() {
        const video = document.getElementById('webcam');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const imageData = canvas.toDataURL('image/jpeg');
        document.getElementById('selfie-image').src = imageData;
        document.getElementById('selfie-data').value = imageData;
        document.getElementById('selfie-preview').classList.remove('hidden');
        document.getElementById('webcam-container').classList.add('hidden');
    }

    function clearSelfie() {
        document.getElementById('selfie-image').src = '';
        document.getElementById('selfie-data').value = '';
        document.getElementById('selfie-preview').classList.add('hidden');
        document.getElementById('webcam-container').classList.remove('hidden');
    }
</script>
{% endblock %}